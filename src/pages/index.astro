---
import Layout from '../layouts/Layout.astro';
import PriceCard from '../components/PriceCard.astro';
import Calculator from '../components/Calculator.astro';
import { fetchBcvRate } from '../lib/bcv';
import { fetchBinanceP2PRate } from '../lib/binance';

// ISR: cache at the edge for 5 minutes, serve stale while revalidating
Astro.response.headers.set(
  'Cache-Control',
  'public, s-maxage=300, stale-while-revalidate=60'
);

// Fetch both rates in parallel
const [bcv, binance] = await Promise.all([
  fetchBcvRate(),
  fetchBinanceP2PRate(),
]);

const bcvFailed = !!bcv.error;
const binanceFailed = !!binance.error;
const anyFailed = bcvFailed || binanceFailed;

const now = new Date().toLocaleString('es-VE', {
  timeZone: 'America/Caracas',
  dateStyle: 'long',
  timeStyle: 'short',
});
---

<Layout>
  <main class="w-full max-w-2xl mx-auto flex flex-col items-center gap-8">
    <header class="text-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
        Tasa del <span class="text-emerald-400">Dolar</span>
      </h1>
      <p class="text-slate-400 mt-2 text-sm sm:text-base">
        Precio en bolivares (VES)
      </p>
    </header>

    <div class="flex flex-col sm:flex-row gap-6 w-full justify-center items-center">
      <PriceCard
        rate={bcv}
        label="BCV"
        sublabel="Tasa Oficial"
        accent="emerald"
        id="card-bcv"
      />
      <PriceCard
        rate={binance}
        label="Binance P2P"
        sublabel="USDT / VES (mediana)"
        accent="amber"
        id="card-bin"
      />
    </div>

    <Calculator
      bcvRate={'price' in bcv && bcv.price != null ? bcv.price : null}
      binanceRate={'price' in binance && binance.price != null ? binance.price : null}
    />

    <footer class="text-center text-xs text-slate-600 mt-4 space-y-1">
      <p>Actualizado: {now} (hora de Caracas)</p>
      <p>Se actualiza automaticamente cada 5 minutos</p>
    </footer>
  </main>

  {anyFailed && (
    <script
      data-need-bcv={bcvFailed ? 'true' : undefined}
      data-need-bin={binanceFailed ? 'true' : undefined}
      is:inline
    >
      (function () {
        var s = document.currentScript;
        var needBcv = s.getAttribute('data-need-bcv') === 'true';
        var needBin = s.getAttribute('data-need-bin') === 'true';
        if (!needBcv && !needBin) return;

        function fmt(n) {
          return n.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function patchCard(id, price) {
          var card = document.getElementById(id);
          if (!card) return;
          var inner = card.querySelector('.text-center');
          if (!inner) return;
          var color = id === 'card-bcv' ? 'text-emerald-400' : 'text-amber-400';
          inner.innerHTML =
            '<p class="text-4xl sm:text-5xl font-extrabold tracking-tight ' + color + '">Bs ' + fmt(price) + '</p>' +
            '<p class="text-xs text-slate-500 mt-3">hace un momento</p>';
        }

        function patchCalc(key, price) {
          var calc = document.getElementById('calc');
          if (!calc) return;
          calc.dataset[key] = String(price);
        }

        var only = needBcv && needBin ? '' : needBcv ? '?only=bcv' : '?only=bin';
        fetch('/api/rates' + only)
          .then(function (r) { return r.json(); })
          .then(function (d) {
            if (needBcv && d.bcv && !d.bcv.error) {
              patchCard('card-bcv', d.bcv.price);
              patchCalc('bcv', d.bcv.price);
            }
            if (needBin && d.binance && !d.binance.error) {
              patchCard('card-bin', d.binance.price);
              patchCalc('bin', d.binance.price);
            }
          })
          .catch(function () {});
      })();
    </script>
  )}
</Layout>
